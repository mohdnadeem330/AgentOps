/**
 * @description       : 
 * @author            : ChangeMeIn@UserSettingsUnder.SFDoc
 * @group             : 
 * @last modified on  : 08-08-2025
 * @last modified by  : ChangeMeIn@UserSettingsUnder.SFDoc
**/
@isTest
private class CaseTriggerHandlerTest {
    // Added By Moh Sarfaraj for Test class Coverage starts
    @testSetup
    static void createData(){
        
        Trigger_Enabler__c triggerEnabler = new Trigger_Enabler__c();
            triggerEnabler.Name = 'Asset';
            triggerEnabler.Is_After_Update__c =false;
            triggerEnabler.Is_After_Insert__c =false;
            triggerEnabler.Is_After_Delete__c = false;
            triggerEnabler.Is_Before_Delete__c = false;
            triggerEnabler.Is_Before_Insert__c = false;
            triggerEnabler.Is_Before_Update__c = false;
            insert triggerEnabler;
        
        Case caseRecord = new Case();
        caseRecord.RecordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('Home_Finance').getRecordTypeId();
        caseRecord.CaseCategory__c = 'Home Finance';
        caseRecord.CaseComments__c = 'Home Finance Parent Case';
        //caseRecord.Home_Finance_Facilitator__c = 'Huspy';
        caseRecord.Status = 'New';
        caseRecord.SubVertical__c = 'Home Finance';
        // caseRecord.Sum_of_Total_Commission_for_Aldar__c = 10000;
        insert caseRecord;
        
        Attachment att = new Attachment();
        att.ParentId   = caseRecord.Id;
        Blob bodyBlob  = Blob.valueOf('Unit Test Attachment Body');
        att.body       = bodyBlob;
        att.Name       = 'attachHarry';
        insert att;
        
        Case caseRecordChild = new Case();
        caseRecordChild.ParentId = caseRecord.Id;
        caseRecordChild.RecordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('Home_Finance').getRecordTypeId();
        caseRecordChild.CaseCategory__c = 'Home Finance';
        caseRecordChild.CaseComments__c = 'Home Finance Parent Case';
        // caseRecordChild.Home_Finance_Facilitator__c = 'Huspy';
        // caseRecordChild.Disbursement_Date__c = System.today();
        // caseRecordChild.Bank_Name__c = 'IDFC Bank';
        // caseRecordChild.Disbursement_Amount__c = 10000;
        // caseRecordChild.Applicable_Payout_Rate__c = 1;
        caseRecordChild.Status = 'New';
        caseRecordChild.SubVertical__c = 'Home Finance';
        insert caseRecordChild;
        
        Account orgAcc = TestObjectsFactory.getAccountRecord('Organization Account',false,'JO20220211');
        orgAcc.recordTypeID=Constants.BROKER_AGENCY_RECORD_TYPE_ID ;
        orgAcc.OwnerManagerEmail__c = 'test@gmail.com';
        insert orgAcc;
        Contact conta1 = TestObjectsFactory.contactDataSetup(orgAcc.Id);
   }
    @isTest
    public static void testCoverageForEmailToCase(){
        Profile p = [SELECT Id FROM Profile WHERE Name = 'System Administrator' LIMIT 1];
        
        User managerUser = new User(
            FirstName = 'Manager',
            LastName = 'User',
            Email = 'manager@gmail.com',
            Username = 'mgruser' + System.currentTimeMillis() + '@test.com',
            Alias = 'mgrusr',
            EmailEncodingKey = 'UTF-8',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            TimeZoneSidKey = 'Asia/Dubai',
            ProfileId = p.Id
        );
        insert managerUser;
        
        User ownerUser = new User(
            FirstName = 'Owner',
            LastName = 'User',
            Email = 'owner@gmail.com',
            Username = 'ownuser' + System.currentTimeMillis() + '@test.com',
            Alias = 'ownusr',
            EmailEncodingKey = 'UTF-8',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            TimeZoneSidKey = 'Asia/Dubai',
            ProfileId = p.Id,
            ManagerId = managerUser.Id
        );
        insert ownerUser;
		QueueSobject queueSobj = new QueueSobject();
        Group queueGroup = new Group();
        System.runAs(ownerUser) {
        
        queueGroup.Name = 'Call Center - Email (External)';
        queueGroup.Type = 'Queue';
        insert queueGroup;
        
        // Associate the Queue with the Case object
        
        queueSobj.QueueId = queueGroup.Id;
        queueSobj.SobjectType = 'Case';
        insert queueSobj;
        }
        List<Case> caseList =new List<Case>(); 
        Account newAccount = TestObjectsFactory.getPersonAccountRecord();
        newAccount.OwnerManagerEmail__c = 'test@gmail.com';
        newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert newAccount;
        
        Project__c project = TestObjectsFactory.getProjectRecord('Test');
        project.AsiteProjectName__c = 'Test Project Name';
        insert project;
        
        BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
        insert buildingSection;
        
        Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
        unit.Status__c = 'Sold';
        insert unit;
        
        
        
        Group grp =[SELECT id,name  from Group where name = 'Call Center - Email (External)' LIMIT 1];
        Case caseRecordEmailTOCase = new Case();
        caseRecordEmailTOCase.RecordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('ECSS_Email_to_Case').getRecordTypeId();
        caseRecordEmailTOCase.CaseCategory__c = 'Home Finance';
        caseRecordEmailTOCase.CaseComments__c = 'Home Finance Parent Case';
        //caseRecord.Home_Finance_Facilitator__c = 'Huspy';
        caseRecordEmailTOCase.Status = 'New';
        caseRecordEmailTOCase.OwnerId = queueGroup.id;
        caseRecordEmailTOCase.SubVertical__c = 'Home Finance';
        caseRecordEmailTOCase.Priority ='P3';  
        caseRecordEmailTOCase.Origin ='Email';
        caseRecordEmailTOCase.Description='Classification : Internal General Purpose';
        // caseRecord.Sum_of_Total_Commission_for_Aldar__c = 10000;
        try{
            insert caseRecordEmailTOCase;
        }catch(Exception ex){
            
        }
        
         Case caseRecordEmailTOCase1 = new Case();
        caseRecordEmailTOCase1.RecordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('ECSS_Maintenance').getRecordTypeId();
        caseRecordEmailTOCase1.CaseCategory__c = 'Home Finance';
        caseRecordEmailTOCase1.CaseComments__c = 'Home Finance Parent Case';
        //caseRecord.Home_Finance_Facilitator__c = 'Huspy';
        caseRecordEmailTOCase1.Status = 'New';
        caseRecordEmailTOCase1.OwnerId = queueGroup.id;
        caseRecordEmailTOCase1.SubVertical__c = 'Home Finance';
        caseRecordEmailTOCase1.Priority ='P3';  
        caseRecordEmailTOCase1.Origin ='Email';
        caseRecordEmailTOCase1.Description='Classification : Internal General Purpose';
        // caseRecord.Sum_of_Total_Commission_for_Aldar__c = 10000;
        try{
            insert caseRecordEmailTOCase1;
        }catch(Exception ex){
            
        }
  
        
      
        
   }
    
    
    @isTest
    public static void testCoverageForDLP1(){
        List<Case> caseList =new List<Case>(); 
        Account newAccount = TestObjectsFactory.getPersonAccountRecord();
        newAccount.OwnerManagerEmail__c = 'test@gmail.com';
        newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert newAccount;
        
        Project__c project = TestObjectsFactory.getProjectRecord('Test');
        project.AsiteProjectName__c = 'Test Project Name';
        insert project;
        
        BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
        insert buildingSection;
        
        Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
        unit.Status__c = 'Sold';
        insert unit;
        Id recTpId =Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('AMC').getRecordTypeId();
        Case case2 = TestObjectsFactory.getCaseRecord(recTpId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Customer Portal');
        case2.CustomerType__c = 'Owner';        
        case2.SubVertical__c = 'AMC';
        case2.ResolutionType__c = null;
        case2.Vertical__c = 'DLP';
        case2.CaseCategory__c = 'PPM';
        Case2.SuppliedEmail ='test@gmail.com';
        case2.SubCategory__c = null;
        case2.Assigned_To__c = UserInfo.getUserId();
        case2.isCreatedFromVisit__c = true;
        case2.ServiceCloudCaseNumber__c = 'test';
        caseList.add(case2);
        INSERT caseList;
        Set<string> emailStringSet = new Set<String>();
        emailStringSet.add('test@gmail.com');
        test.startTest();
        CaseTriggerHandler.caseEmailValidation(caseList,emailStringSet);
        CaseTriggerHandler.CreateResolvertask(caseList);
        test.stopTest();
        
    }
    @isTest
    public static void testCoverageForDLP(){
        
        Account newAccount = TestObjectsFactory.getPersonAccountRecord();
        newAccount.OwnerManagerEmail__c = 'test@gmail.com';
        newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert newAccount;
        
        
        Account ac = [SELECT PersonContactId  FROM Account LIMIT 1];
        system.debug('personContactId'+ac.PersonContactId);
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(newAccount.Id);
        opp.OwnerManger__c = UserInfo.getUserId();
        insert opp;
        
        Unit__c unit = TestObjectsFactory.unitDataSetup('25083');
        unit.Status__c = 'Sold';
        insert unit;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, newAccount.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.Account__c =newAccount.Id; 
        salesOrder.IsBookingCompleted__c = true;
        salesOrder.NetAmount__c = 100000;
        
        salesOrder.SellingPrice__c=1000000;
        insert salesOrder;
        
        Profile profile = [SELECT Id FROM Profile WHERE Name = 'Standard User']; // Adjust profile name as needed
        User testUser = new User(
            ProfileId = profile.Id,
            LastName = 'Test',
            FirstName = 'User',
            Email = 'testuser@example.com',
            Username = 'testuser@example.com' + System.currentTimeMillis(),
            Alias = 'tuser',
            EmailEncodingKey = 'UTF-8',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            TimeZoneSidKey = 'America/Los_Angeles',
            IsActive = true
        );
        insert testUser;
        
        test.startTest();  
        Id recordTypeId =  Schema.SObjectType.Case.getRecordTypeInfosByName().get('DLP').getRecordTypeId();
        system.debug('PersonContacrId--> '+ ac.PersonContactId);
        system.debug('recordtypeid'+recordTypeId);
        system.debug('unit'+ unit.Id);
        system.debug('so '+ salesOrder.Id);
        Case c = new Case(ContactId = ac.PersonContactId,AccountId=newAccount.Id,CustomerType__c='Owner',RecordTypeId=recordTypeId,Unit__c=unit.Id,SalesOrder__c=salesOrder.Id,Vertical__c='DLP',Origin='Phone',SubVertical__c='DLP',CaseCategory__c='Civil',SubCategory__c='Aluminium',ResolutionType__c='Replace',Skills_Required__c='Electrician',Single_DLP_slot__c=true);
        INSERT c;
        try{
            TriggerHandler.processedIds = new Set<Id>();
            c.Origin = 'Email';
            c.Ownership_Bulk_Changed__c = true;
            c.OwnerId = testUser.Id;
            UPDATE c;
        }
        catch(Exception e){
            
        }
        test.stopTest();
        
    }
    @isTest
    public static void testCoverageForOPPLi(){
        Account newAccount = TestObjectsFactory.getPersonAccountRecord();
        newAccount.OwnerManagerEmail__c = 'test@gmail.com';
        newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert newAccount;
        
        Account ac = [SELECT PersonContactId  FROM Account LIMIT 1];
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(newAccount.Id);
        opp.OwnerManger__c = UserInfo.getUserId();
        insert opp;
        
        Unit__c unit = TestObjectsFactory.unitDataSetup('25083');
        unit.Status__c = 'Sold';
        insert unit;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, newAccount.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.Account__c =newAccount.Id; 
        salesOrder.IsBookingCompleted__c = true;
        salesOrder.NetAmount__c = 100000;
        salesOrder.SellingPrice__c=1000000;
        insert salesOrder;
        
        
        List<Product2> products = new List<Product2>{
            new Product2(Name = 'Handyman', IsActive = true,Type__c='On Demand',Family='Apartments- Basic Packages'),
                new Product2(Name = 'Duct Cleaning', IsActive = true,Type__c='On Demand',Family='Apartments- Basic Packages'),
                new Product2(Name = 'Pest Control', IsActive = true,Type__c='On Demand',Family='Apartments- Basic Packages')
                };
                    insert products; 
        Schema.Location loc = new Schema.Location();
        loc.Name = 'Test Location'; 
        //loc.Longitude = '28.635308';
        loc.IsInventoryLocation = true;
        insert loc;
        // Name is required
        
        
        
        list<ProductItem> lstPI = new list<ProductItem>();
        for(Product2 p:products){
            lstPI.add (new ProductItem(Product2Id = p.Id, QuantityOnHand=5,locationId=loc.Id));    
        }
        INSERT lstPI;
        
        List<OpportunityOfferLine__c> lstOppLi =  new List<OpportunityOfferLine__c>{
            new OpportunityOfferLine__c(Name='Handyman',SalesOrder__c=salesOrder.Id ,/*Product__c=products[0].Id,*/Product_Item__c=lstPI[0].Id),
                new OpportunityOfferLine__c(Name='Duct Cleaning',SalesOrder__c=salesOrder.Id, /*Product__c=products[1].Id,*/Product_Item__c=lstPI[1].Id),
                new OpportunityOfferLine__c(Name='Pest Control',SalesOrder__c=salesOrder.Id, /*Product__c=products[2].Id,*/Product_Item__c=lstPI[2].Id)
                };
                    INSERT lstOppLi;
        Id recordTypeId =  Schema.SObjectType.Case.getRecordTypeInfosByName().get('AMC').getRecordTypeId();
        Case c = new Case(AccountId=newAccount.Id,CustomerType__c='Owner',RecordTypeId=recordTypeId,Unit__c=unit.Id,SalesOrder__c=salesOrder.Id,Vertical__c='DLP',SubVertical__c='AMC',CaseCategory__c='On Demand',SubCategory__c='Handyman');
        
        INSERT c;
        test.startTest();
        TriggerHandler.processedIds = new Set<Id>();
        
        Case cs = [SELECT Id,AMC_Closure_Reason__c,Status FROM Case WHERE CaseCategory__c='On Demand' LIMIT 1];
        cs.AMC_Closure_Reason__c = 'Completed Sucessfully';
        cs.Status = 'Closed';
        cs.ContactId = ac.PersonContactId;
        UPDATE cs;
        cs.AMC_Closure_Reason__c = 'Customer Not Available - No Access';
        cs.Status = 'Work In Progress';
        UPDATE cs;
        TriggerHandler.processedIds = new Set<Id>();
        cs.Status = 'Closed';
        UPDATE cs;
        test.stopTest();
        
    }
    
    
    @isTest
    static void testCurrentUserWithPermission() {
        Project__c project = TestObjectsFactory.getProjectRecord('Test');
        project.AsiteProjectName__c = 'Test Project Name';
        insert project;
        
        BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
        insert buildingSection;
        
        Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
        unit.Status__c = 'Sold';
        insert unit;
        
        Account newAccount = TestObjectsFactory.getPersonAccountRecord();
        newAccount.PassportNumber__pc = 'N6385378';
        newAccount.ResidentStatus__pc = 'Resident';
        newAccount.MaritalStatus__pc = 'Married';
        newAccount.EmploymentStatus__pc = 'Self Employed';
        newAccount.PersonEmail = 'test@aldar.com.invalid';
        newAccount.MobileCountryCode__pc = '971';
        newAccount.MobilePhone__pc = '9876543115';
        newAccount.Company__pc = 'XXXXX';
        newAccount.Position__pc = 'XXX';
        newAccount.CompanyAddress__pc = 'NA';
        newAccount.NoofYearswithCompany__pc = 10;
        newAccount.Industry = 'Agriculture';
        newAccount.AnnualIncome__pc = 1234567;
        newAccount.NationalIdNumber__pc = '784123456789012';
        newAccount.SourceofFunds__pc = 'Profits/Salary';
        newAccount.OwnerManagerEmail__c = 'test@gmail.com';
        newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert newAccount;
        
        
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(newAccount.Id);
        opp.OwnerManger__c = UserInfo.getUserId();
        insert opp;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, newAccount.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.IsBookingCompleted__c = true;
        salesOrder.NetAmount__c = 100000;
        salesOrder.Account__c = newAccount.Id;
        insert salesOrder;
        
        Profile profile = [SELECT Id FROM Profile WHERE Name = 'Standard User']; // Adjust profile name as needed
        User testUser = new User(
            ProfileId = profile.Id,
            LastName = 'Test',
            FirstName = 'User',
            Email = 'testuser@example.com',
            Username = 'testuser@example.com' + System.currentTimeMillis(),
            Alias = 'tuser',
            EmailEncodingKey = 'UTF-8',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            TimeZoneSidKey = 'America/Los_Angeles',
            IsActive = true
        );
        insert testUser;
        
        Id standardRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
        
        Id dlpRecordTypeId = Utilities.getRecordTypeId('Case', 'DLP');
        Case newStandardCase2 = TestObjectsFactory.getCaseRecord(dlpRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newStandardCase2.SubVertical__c = Constants.DLP_SUB_VERTICAL;
        newStandardCase2.CaseCategory__c = 'Civil';
        newStandardCase2.SubCategory__c = 'Aluminium';
        newStandardCase2.ProblemCode__c = 'CM-PQA- Window frame';
        newStandardCase2.IncidentDescription__c = 'Scratched';
        newStandardCase2.ResolutionType__c = 'Repair';
        newStandardCase2.RecordId__c = unit.Id;
        newStandardCase2.OwnerId = testUser.id;
        newStandardCase2.Subject='Test2';
        Test.startTest();
        insert newStandardCase2;
        
        Case newFeedbackCase3 = TestObjectsFactory.getCaseRecord(standardRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase3.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase3.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase3.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase3.OwnerId = testUser.id;
        newFeedbackCase3.CustomerType__c = 'Owner';
        newFeedbackCase3.RecordId__c = unit.Id;
        //newFeedbackCase3.AccountId=acc.id;
        newFeedbackCase3.Subject='Noya-Civil';
        insert newFeedbackCase3;
        
        Set<id> idsset = New Set<Id>();
        List<Case> cslist = New List<Case>();
        cslist.add(newStandardCase2);
        idsset.add(newStandardCase2.Id);
        CaseTriggerHandler.sentEmailToHuspyAfterVerified(idsset);
        CaseTriggerHandler.createCommissionRecord(idsset, cslist);
        //List<Case> CaseList = new List<Case>();
        // List<Case> CaseList = [Select id, Vertical__c,SubVertical__c from case];
        // Case_Ownership_Change_Users__mdt metadata = [Select id from Case_Ownership_Change_Users__mdt limit 1];
        //CaseList.add(testcase);
        
        
        newStandardCase2.OwnerId = Userinfo.getUserId();
        newFeedbackCase3.OwnerId = Userinfo.getUserId();
        update newStandardCase2;
        update newFeedbackCase3;
        // Call the method with the test data
        //  CaseTriggerHandler.updateCaseOwner(CaseList);
        Test.stopTest();
    }
    
    @isTest
    public static void UpdateDetailsCase (){
        try{
        Profile p = [SELECT Id FROM Profile WHERE Name = 'System Administrator' LIMIT 1];
        User managerUser = new User(
            FirstName = 'Manager',
            LastName = 'User',
            Email = 'manager@gmail.com',
            Username = 'mgruser' + System.currentTimeMillis() + '@test.com',
            Alias = 'mgrusr',
            EmailEncodingKey = 'UTF-8',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            TimeZoneSidKey = 'Asia/Dubai',
            ProfileId = p.Id
        );
        insert managerUser;
        
        User ownerUser = new User(
            FirstName = 'Owner',
            LastName = 'User',
            Email = 'owner@gmail.com',
            Username = 'ownuser' + System.currentTimeMillis() + '@test.com',
            Alias = 'ownusr',
            EmailEncodingKey = 'UTF-8',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            TimeZoneSidKey = 'Asia/Dubai',
            ProfileId = p.Id,
            ManagerId = managerUser.Id
        );
        insert ownerUser;
        
        System.runAs(ownerUser){
            Test.startTest(); 
            Project__c project = TestObjectsFactory.getProjectRecord('Test');
            project.AsiteProjectName__c = 'Test Project Name';
            insert project;
            
            BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
            insert buildingSection;
            
            Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
            unit.Status__c = 'Sold';
            insert unit;
            system.debug('unit-->'+ unit);
            
            Account newAccount = TestObjectsFactory.getPersonAccountRecord();
            newAccount.PassportNumber__pc = 'N6385378';
            newAccount.ResidentStatus__pc = 'Resident';
            newAccount.MaritalStatus__pc = 'Married';
            newAccount.EmploymentStatus__pc = 'Self Employed';            newAccount.PersonEmail = 'test@aldar.com.invalid';
            newAccount.MobileCountryCode__pc = '971';
            newAccount.MobilePhone__pc = '9876543115';
            newAccount.Company__pc = 'XXXXX';
            newAccount.Position__pc = 'XXX';
            newAccount.CompanyAddress__pc = 'NA';
            newAccount.NoofYearswithCompany__pc = 10;
            newAccount.Industry = 'Agriculture';
            newAccount.AnnualIncome__pc = 1234567;
            newAccount.NationalIdNumber__pc = '784123456789012';
            newAccount.SourceofFunds__pc = 'Profits/Salary';
            newAccount.VisaType__c = 'Golden Visa';
            insert newAccount;
            
            newAccount.OwnerId = ownerUser.Id;
            update newAccount;
            
            Opportunity opp = TestObjectsFactory.getOpportunityRecord(newAccount.Id);
            opp.OwnerManger__c = UserInfo.getUserId();
            insert opp;
            SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, newAccount.Id);
            salesOrder.Unit__c = unit.Id;
            salesOrder.IsBookingCompleted__c = true;
            salesOrder.NetAmount__c = 100000;
            salesOrder.Account__c = newAccount.Id;
            insert salesOrder;
            
            Id standardRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
            system.debug('recordTypeId--->'+ standardRecordTypeId);
            
            
            Case updatecase = TestObjectsFactory.getCaseRecord(standardRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
            updatecase.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
            updatecase.CaseCategory__c = Constants.CONTACT_DETAILS_UPDATE_CATEGORY;
            updatecase.Unit__c = unit.Id;
            updatecase.subject='Test';
            updatecase.CustomerType__c = 'Owner';
            updatecase.AccountId = newAccount.Id;
            updatecase.Email__c = newAccount.PersonEmail;

             system.debug('updatecase-->'+ updatecase);
            insert updatecase;
            
            // TriggerHandler.processedIds = new Set<Id>();
            
            //update updatecase;
            
            
            TriggerHandler.processedIds = new Set<Id>();
            updatecase.Status = Constants.CLOSED_CASE;
            updatecase.Origin = Constants.CASE_ORIGIN_CUSTOMER_PORTAL;
            updatecase.StatusReason__c = Constants.WITH_RESOLUTION_CASE;
            updatecase.CustomerInformationConfirmed__c = true;
            updatecase.ResidentStatus__c = 'Resident';
            updatecase.PassportNumber__c = 'asd123';
            updatecase.EmploymentStatus__c = 'Self Employed';
            updatecase.Company__c = 'Unemployed';
            updatecase.Position__c = 'Unemployed';
            updatecase.CompanyAddress__c = 'Unemployed';
            updatecase.NumberOfYearsWithCompany__c = 5;
            updatecase.AnnualIncome__c = 5000;
            updatecase.Industry__c = 'Agriculture';
            updatecase.MobileCountryCode__c = '962';
            //updatecase.MobileNumber__c = '787120342';
            //updatecase.Email__c = 'ali.athamneh@pwc.com';
            updatecase.MaritalStatus__c = 'Married';
            updatecase.PermanentStreet__c = 'Test Street';
            updatecase.PermanentCity__c = 'Dubai';
            updatecase.PermanentState__c = 'Dubai';
            updatecase.PermanentCountry__c = 'United Arab Emirates';
            updatecase.PassportNumber__c = 'N2345346';
            updatecase.PassportType__c = 'Ordinary';
            updatecase.PlaceofIssue__c = 'Dubai';
            updatecase.PassportIssueDate__c = Date.today().addDays(-15);
            updatecase.PassportExpiryDate__c = Date.today().addDays(15);
            updatecase.ResidentStatus__c = 'Resident';
            updatecase.Current_Residential_Country__c = 'United Arab Emirates';
            updatecase.Nationality__c = 'United Arab Emirates';
            updatecase.NationalIdNumber__c = '784123456789012';
            updatecase.NationalIdExpiryDate__c = Date.today().addDays(15);
            //        updatecase.SourceofFunds__c = 'Employment Income';
            
            update updatecase;
            CaseTriggerHandler.getEmailsFromPublicGroup(System.Label.DLPManagerGroupName);
            // CaseTriggerHandler.Update_M1();
             Test.stopTest();
        }
        }catch(Exception ex){
            
        }
    }
    
    @isTest
    public static void createUpdateCase_Feedback (){
        
        Project__c project = TestObjectsFactory.getProjectRecord('Test');
        project.AsiteProjectName__c = 'Test Project Name';
        insert project;
        
        BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
        insert buildingSection;
        
        Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
        unit.Status__c = 'Sold';
        insert unit;
        
        Account newAccount = TestObjectsFactory.getPersonAccountRecord();
        newAccount.PassportNumber__pc = 'N6385378';
        newAccount.ResidentStatus__pc = 'Resident';
        newAccount.MaritalStatus__pc = 'Married';
        newAccount.EmploymentStatus__pc = 'Self Employed';
        newAccount.PersonEmail = 'test@aldar.com.invalid';
        newAccount.MobileCountryCode__pc = '971';
        newAccount.MobilePhone__pc = '9876543115';
        newAccount.Company__pc = 'XXXXX';
        newAccount.Position__pc = 'XXX';
        newAccount.CompanyAddress__pc = 'NA';
        newAccount.NoofYearswithCompany__pc = 10;
        newAccount.Industry = 'Agriculture';
        newAccount.AnnualIncome__pc = 1234567;
        newAccount.NationalIdNumber__pc = '784123456789012';
        newAccount.SourceofFunds__pc = 'Profits/Salary';
        newAccount.OwnerManagerEmail__c = 'test@gmail.com';
        newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert newAccount;
        
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(newAccount.Id);
        opp.OwnerManger__c = UserInfo.getUserId();
        insert opp;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, newAccount.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.IsBookingCompleted__c = true;
        salesOrder.NetAmount__c = 100000;
        salesOrder.Account__c = newAccount.Id;
        insert salesOrder;
        
        // Id standardRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
        
        Test.startTest();  
        
        
        Id feedbackRecordTypeId = Utilities.getRecordTypeId('Case', Constants.FEEDBACK_CASE_RT);
        List<Case> caseList=new  List<Case>();
        Case newFeedbackCase = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase.SubVertical__c = 'Defaults & Collection';
        newFeedbackCase.CaseCategory__c = 'Payment Extension';
        newFeedbackCase.RecordId__c = unit.Id;
        caseList.add(newFeedbackCase);
        Id recTpId =Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('AMC').getRecordTypeId();
        Case case2 = TestObjectsFactory.getCaseRecord(recTpId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Customer Portal');
        case2.CustomerType__c = 'Owner';        
        case2.SubVertical__c = 'AMC';
        case2.ResolutionType__c = null;
        case2.Vertical__c = 'DLP';
        case2.CaseCategory__c = 'PPM';
        case2.SubCategory__c = null;
        case2.isCreatedFromVisit__c = true;
        caseList.add(case2);
        INSERT caseList;
        
        TriggerHandler.processedIds = new Set<Id>();
        List<Case> caseListUpdt=new  List<Case>();
        case c = [SELECT Id,SubVertical__c,CaseCategory__c,Origin FROM Case WHERE CaseCategory__c = 'Payment Extension' LIMIT 1];
        c.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        c.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        c.Origin = Constants.SURVEY_CASE_ORIGIN;
        caseListUpdt.add(c);
        TriggerHandler.processedIds = new Set<Id>();
        case c2 = [SELECT Id,SubVertical__c,CaseCategory__c,SubCategory__c FROM Case WHERE CaseCategory__c = 'PPM' LIMIT 1];
        c2.SubCategory__c = 'PPM Visit'; 
        caseListUpdt.add(c2);
        update caseListUpdt;
        
    }
    
    @isTest
    public static void feedbackcaseCaseTest(){
        Account newAccount = TestObjectsFactory.getPersonAccountRecord();
        newAccount.OwnerManagerEmail__c = 'test@gmail.com';
        newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert newAccount;
        
        Project__c project = TestObjectsFactory.getProjectRecord('Test');
        project.AsiteProjectName__c = 'Test Project Name';
        insert project;
        
        BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
        insert buildingSection;
        
        Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
        unit.Status__c = 'Sold';
        insert unit;
        TriggerHandler.processedIds = new Set<Id>();
        Id standardRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
        Case newStandardCase = TestObjectsFactory.getCaseRecord(standardRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, Constants.SURVEY_CASE_ORIGIN);
        newStandardCase.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newStandardCase.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newStandardCase.RecordId__c = unit.Id;
        insert newStandardCase;
        Test.startTest();
        TriggerHandler.processedIds = new Set<Id>();
        Id feedbackRecordTypeId = Utilities.getRecordTypeId('Case', Constants.FEEDBACK_CASE_RT);
        Case newFeedbackCase = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase.SubVertical__c = 'Defaults & Collection';
        newFeedbackCase.CaseCategory__c = 'Payment Extension';
        newFeedbackCase.RecordId__c = unit.Id;
        insert newFeedbackCase;
        
        Id recTpId =Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('AMC').getRecordTypeId();
        Case newFeedbackCase4 = TestObjectsFactory.getCaseRecord(recTpId,'', unit.Id, 'Phone');
        newFeedbackCase4.CustomerType__c = 'Owner';
        newFeedbackCase4.SubVertical__c = 'AMC';
        newFeedbackCase4.Vertical__c = 'DLP';
        newFeedbackCase4.CaseCategory__c = 'PPM';
        newFeedbackCase4.CaseCategory__c = 'PPM Visit';          
        newFeedbackCase4.RecordId__c = unit.Id;
        newFeedbackCase4.Subject='Noya-Civil';
        newFeedbackCase4.isCreatedFromVisit__c = true;
        insert newFeedbackCase4;
        newFeedbackCase4.Customer_Response__c = 'First Call';
        UPDATE newFeedbackCase4;
        
        Account accCont = [Select Id,PersonContactId From Account Where PersonContactId != null Limit 1];
        
        Case c = [SELECT Id,Customer_Response__c FROM Case WHERE Recordtype_Name__c = 'AMC' LIMIT 1];
        c.Customer_Response__c = 'Last Call';
        c.ContactId = accCont.PersonContactId;
        UPDATE c;
        CaseTriggerHandler.sendServiceReport(new Set<Id>{c.Id});
        Test.stopTest();
        newFeedbackCase.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase.Status = 'Closed';
        // Update newFeedbackCase;               
        
    }
    @isTest
    public static void createUpdateCase2 (){
        Test.startTest();
        
        Project__c project = TestObjectsFactory.getProjectRecord('Test');
        project.AsiteProjectName__c = 'Test Project Name';
        insert project;
        
        BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
        insert buildingSection;
        
        Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
        unit.Status__c = 'Sold';
        insert unit;
        
        Account newAccount = TestObjectsFactory.getPersonAccountRecord();
        newAccount.PassportNumber__pc = 'N6385378';
        newAccount.ResidentStatus__pc = 'Resident';
        newAccount.MaritalStatus__pc = 'Married';
        newAccount.EmploymentStatus__pc = 'Self Employed';
        newAccount.PersonEmail = 'test@aldar.com.invalid';
        newAccount.MobileCountryCode__pc = '971';
        newAccount.MobilePhone__pc = '9876543115';
        newAccount.Company__pc = 'XXXXX';
        newAccount.Position__pc = 'XXX';
        newAccount.CompanyAddress__pc = 'NA';
        newAccount.NoofYearswithCompany__pc = 10;
        newAccount.Industry = 'Agriculture';
        newAccount.NationalIdNumber__pc = '784123456789012';
        newAccount.AnnualIncome__pc = 1234567;
        newAccount.SourceofFunds__pc = 'Profits/Salary';
        newAccount.OwnerManagerEmail__c = 'test@gmail.com';
        newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert newAccount ; 
        
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(newAccount.Id);
        opp.OwnerManger__c = UserInfo.getUserId();
        insert opp;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, newAccount.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.IsBookingCompleted__c = true;
        salesOrder.NetAmount__c = 100000;
        insert salesOrder;
        
        List<InstallmentLines__c> installmentLineList = TestObjectsFactory.createInstallmentLines(salesOrder.Id, 2);
        
        ReceiptAcknowledgement__c receiptAcknowledgement = TestObjectsFactory.getReceiptAcknowledgementRecord(salesOrder.Id, newAccount.Id, opp.Id, 'Cheque');
        insert receiptAcknowledgement;
        
        ReceiptAllocation__c receiptAllocation = TestObjectsFactory.getReceiptAllocationRecord(receiptAcknowledgement.Id, salesOrder.Id, newAccount.Id, installmentLineList[0].Id);
        insert receiptAllocation;
        
        Id feedbackRecordTypeId = Utilities.getRecordTypeId('Case', Constants.FEEDBACK_CASE_RT);
        Case newFeedbackCase = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase.OwnerId = Userinfo.getUserId();
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase.CaseReopenCount__c = 0;
        insert newFeedbackCase; 
        Test.stopTest();
        List<Case> newList1 = new List<Case>();
        newList1.add(newFeedbackCase);
        
        List<SObject> newList = new List<SObject>();
        newList.add(newFeedbackCase);
        
        map<Id,Id> caseWithSalesOrderMap = new map<Id,Id>();
        caseWithSalesOrderMap.put(newFeedbackCase.Id, salesOrder.Id);
        CaseTriggerHandler.populateLPCInformation(caseWithSalesOrderMap, newList);
        CaseTriggerHandler.taskCreationForCase(newList);
        
        Map<Id,Case> transferredCases = new Map<Id,Case>();
        transferredCases.put(newFeedbackCase.Id, newFeedbackCase);
        CaseTriggerHandler.handleTransferredCases(transferredCases);
        CaseTriggerHandler.updateReopenCount(newList1);
        
    }
    
    @isTest
    public static void createUpdateCase_Service_Appoinment (){
        FSL.GlobalAPIS.addStatusTransition('New', 'Closed');
        Account acc = TestObjectsFactory.getPersonAccountRecord();
        acc.PassportNumber__pc = 'N6385378';
        acc.ResidentStatus__pc = 'Resident';
        acc.MaritalStatus__pc = 'Married';
        acc.EmploymentStatus__pc = 'Self Employed';
        acc.PersonEmail = 'test@aldar.com.invalid';
        acc.MobileCountryCode__pc = '971';
        acc.MobilePhone__pc = '9876543115';
        acc.Company__pc = 'XXXXX';
        acc.Position__pc = 'XXX';
        acc.CompanyAddress__pc = 'NA';
        acc.NoofYearswithCompany__pc = 10;
        acc.Industry = 'Agriculture';
        acc.NationalIdNumber__pc = '784123456789012';
        acc.AnnualIncome__pc = 1234567;
        acc.SourceofFunds__pc = 'Profits/Salary';
        acc.OwnerManagerEmail__c = 'test@gmail.com';
        acc.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert acc;
        
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(acc.Id);
        insert opp;
        
        List<Unit__c> unitList=new List<Unit__c>();
        Unit__c unit = TestObjectsFactory.unitDataSetup('25083');
        unit.Status__c = 'Sold';
        unitList.add(unit);
        
        ProjectBudget__c projectBudget = TestObjectsFactory.getProjectBudget();
        insert projectBudget;
        
        Project__c project = TestObjectsFactory.getProjectRecord('ABC');
        project.ProjectBudget__c = projectBudget.Id;
        project.CommunityName__c = 'Noya';
        insert project;
        
        User salesManager = TestObjectsFactory.getUserRecord('Sales Manager', 'ajaythakurSM1');
        salesManager.IsActive = TRUE;
        insert salesManager;
        
        Unit__c unit2 = TestObjectsFactory.unitDataSetup('25084');
        unit2.Project__c = project.id;
        unit2.Status__c = 'New';
        unit2.AssignedToUser__c = salesManager.Id;
        unit2.LatitudeLongitude__Latitude__s=32.987650;
        unit2.LatitudeLongitude__Longitude__s=72.345678;
        unitList.add(unit2);
        insert unitList;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, acc.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.NetAmount__c = 1000;
        salesOrder.SellingPrice__c = 1000;
        insert salesOrder;
        
        Id recordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('DLP').getRecordTypeId();
        Case caseObj = new Case();
        caseObj.AccountId = acc.id;
        caseObj.RecordtypeId = recordTypeId;
        caseObj.Unit__c=unit2.id;
        caseObj.Status = 'New';
        caseObj.Subject = 'Test Case';
        caseObj.Single_DLP_slot__c = true;
        caseObj.Skills_Required__c = 'Electrician';
        Test.startTest();
        caseObj.Status = 'Assigned';
        insert caseObj;
        List<Case> caseList = new List<Case>();
        caseList.add(caseObj);
        system.debug('case insert::'+caseObj.Id);
        map<Id,account> accountIDToRecMap = new map<Id,account>();
        accountIDToRecMap.put(acc.id,acc);
        List<WorkType> workTypeList=new  List<WorkType>();
        WorkType wt = new WorkType();
        wt.Name = 'Electrician';        
        wt.EstimatedDuration = 1;
        //insert wt;
        workTypeList.add(wt);
        WorkType wt1 = new WorkType();
        wt1.Name = 'DLP Executive';        
        wt1.EstimatedDuration = 1;
        workTypeList.add(wt1);
        insert workTypeList;
        
        
        WorkType wt2 = new WorkType();
        wt2.Name = 'Contractor DLP';        
        wt2.EstimatedDuration = 1;
        insert wt2;
        
        WorkOrder woObj = new WorkOrder();
        woObj.CaseId = caseObj.Id;
        woObj.AccountId = acc.Id;
        woObj.WorkTypeId =  wt1.Id;
        woObj.Status = 'New';
        insert woObj;
        FSL__Scheduling_Policy__c scpolicy = New FSL__Scheduling_Policy__c();
        scpolicy.Name = 'Aldar Scheduling Policy';
        insert scpolicy;  
        
        WorkOrderLineItem woliDlp = new WorkOrderLineItem();
        woliDlp.WorkOrderId = woObj.id;
        woliDlp.WorkTypeId = wt1.id;
        woliDlp.Status = 'New';
        insert woliDlp;
        
        Id assessmentRecordTypeId = Schema.SObjectType.ServiceAppointment.getRecordTypeInfosByName().get('Assessment').getRecordTypeId();
        ServiceAppointment testSA = new ServiceAppointment();
        testSA.Case__c = caseObj.Id;
        testSA.ParentRecordId = woliDlp.Id;
        testSA.RecordTypeId = assessmentRecordTypeId; 
        testSA.EarliestStartTime = system.today(); 
        
        insert testSA;
        
        /*  Id assessmentRecordTypeId = Schema.SObjectType.ServiceAppointment.getRecordTypeInfosByName().get('Assessment').getRecordTypeId();
ServiceAppointment testSA = new ServiceAppointment();
testSA.Case__c = caseObj.Id;
testSA.ParentRecordId =  woObj.Id;
testSA.RecordTypeId = assessmentRecordTypeId ; 
testSA.EarliestStartTime = system.today(); 
testSA.Dependency_Required__c= false;
Insert testSA;*/
        
        testSA.SchedStartTime = system.today();        
        testSA.Status = 'Assigned';
        testSA.AccountEmailID__c = 'test@test.com'; 
        testSA.SchedEndTime = system.today()+1; 
        testSA.OwnerId  = UserInfo.getUserId();
        testSA.Supervisor__c = UserInfo.getUserId();
        testSA.Status = 'En Route';  
        testSA.Status = 'Work In Progress'; 
        testSA.Quick_Fix__c=false;  
        testSA.Status = 'Closed';
        testSA.OwnerId = Userinfo.getUserId();
        testSA.Closed_Reason__c='Completed Succeessfully';
        Update  testSA  ; 
        // newFeedbackCase3.Status='Closed';
        ContentVersion testContentVersion = new ContentVersion(
            Title = 'Test Document',
            VersionData = Blob.valueOf('Test Content'),
            PathOnClient = 'test.txt'
        );
        insert testContentVersion; 
        ContentDocumentLink existingContentLink = new ContentDocumentLink(
            ContentDocumentId = [SELECT Id FROM ContentDocument WHERE Title = 'Test Document' LIMIT 1].Id,
            LinkedEntityId = testSA.Id,
            ShareType = 'I'
        );
        insert existingContentLink;
        CaseTriggerHandler.validateDLPCases(caseList);
        Test.stopTest();          
    }
    
    @isTest
    public static void createUpdateCase_SendServiceReport(){
        FSL.GlobalAPIS.addStatusTransition('New', 'Closed');
        Test.startTest();
        Account acc = TestObjectsFactory.getPersonAccountRecord();
        acc.PassportNumber__pc = 'N6385378';
        acc.ResidentStatus__pc = 'Resident';
        acc.MaritalStatus__pc = 'Married';
        acc.EmploymentStatus__pc = 'Self Employed';
        acc.PersonEmail = 'test@aldar.com.invalid';
        acc.MobileCountryCode__pc = '971';
        acc.MobilePhone__pc = '9876543115';
        acc.Company__pc = 'XXXXX';
        acc.Position__pc = 'XXX';
        acc.CompanyAddress__pc = 'NA';
        acc.NoofYearswithCompany__pc = 10;
        acc.Industry = 'Agriculture';
        acc.NationalIdNumber__pc = '784123456789012';
        acc.AnnualIncome__pc = 1234567;
        acc.SourceofFunds__pc = 'Profits/Salary';
        acc.OwnerManagerEmail__c = 'test@gmail.com';
        acc.OwnerManagerEmail__pc = 'test1@gmail.com';
        
        insert acc;
        
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(acc.Id);
        insert opp;
        
        List<Unit__c> unitList=new List<Unit__c>();
        Unit__c unit = TestObjectsFactory.unitDataSetup('25083');
        unit.Status__c = 'Sold';
        unitList.add(unit);
        
        ProjectBudget__c projectBudget = TestObjectsFactory.getProjectBudget();
        insert projectBudget;
        
        Project__c project = TestObjectsFactory.getProjectRecord('ABC');
        project.ProjectBudget__c = projectBudget.Id;
        project.CommunityName__c = 'Noya';
        insert project;
        
        User salesManager = TestObjectsFactory.getUserRecord('Sales Manager', 'ajaythakurSM1');
        salesManager.IsActive = TRUE;
        insert salesManager;
        
        Unit__c unit2 = TestObjectsFactory.unitDataSetup('25084');
        unit2.Project__c = project.id;
        unit2.Status__c = 'New';
        unit2.AssignedToUser__c = salesManager.Id;
        unit2.LatitudeLongitude__Latitude__s=32.987650;
        unit2.LatitudeLongitude__Longitude__s=72.345678;
        unitList.add(unit2);
        insert unitList;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, acc.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.NetAmount__c = 1000;
        salesOrder.SellingPrice__c = 1000;
        insert salesOrder;
        
        // Id standardRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
        Id feedbackRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
        Case newFeedbackCase = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase.OwnerId = Userinfo.getUserId();
        //  newFeedbackCase.RecordId__c = SR.Id;
        // insert newFeedbackCase;
        
        Case newFeedbackCase2 = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase2.SubVertical__c = Constants.DLP_SUB_VERTICAL;
        newFeedbackCase2.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase2.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase2.OwnerId = Userinfo.getUserId();
        newFeedbackCase2.RecordId__c = opp.Id;
        //insert newFeedbackCase2;
        
        Case newFeedbackCase3 = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase3.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase3.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase3.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase3.OwnerId = Userinfo.getUserId();
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase3.RecordId__c = salesOrder.Id;
        newFeedbackCase3.AccountId=acc.id;
        newFeedbackCase3.Subject='Noya-Civil';
        //insert newFeedbackCase3;
        
        //  Id feedbackRecordTypeId = Utilities.getRecordTypeId('Case', 'DLP');
        Case newFeedbackCase4 = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase4.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase4.CaseCategory__c = Constants.CONTACT_DETAILS_UPDATE_CATEGORY;
        newFeedbackCase4.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase4.OwnerId = Userinfo.getUserId();
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase4.RecordId__c = salesOrder.Id;
        newFeedbackCase4.AccountId=acc.id;
        newFeedbackCase4.Subject='Noya-Civil';
        
        Id recordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('DLP').getRecordTypeId();
        Case caseObj = new Case();
        caseObj.AccountId = acc.id;
        caseObj.RecordtypeId = recordTypeId;
        caseObj.Unit__c=unit2.id;
        caseObj.Status = 'New';
        caseObj.Subject = 'Test Case';
        caseObj.Single_DLP_slot__c = true;
        //caseObj.Skills_Required__c = 'Electrician';
        insert caseObj;
        system.debug('case insert::'+caseObj.Id);        
        map<Id,account> accountIDToRecMap = new map<Id,account>();
        accountIDToRecMap.put(acc.id,acc);  
        Map<Id, Case> closedCasesMap = new Map<Id, Case>();
        Task t = new Task();
        
        t.WhatId=newFeedbackCase3.id;
        insert t;
        Test.stopTest();
        // closedCasesMap.put(newFeedbackCase3.id,newFeedbackCase3);
        
        List<WorkType> workTypeList=new  List<WorkType>();
        WorkType wt = new WorkType();
        wt.Name = 'Electrician';        
        wt.EstimatedDuration = 1;
        //insert wt;
        workTypeList.add(wt);
        WorkType wt1 = new WorkType();
        wt1.Name = 'DLP Executive';        
        wt1.EstimatedDuration = 1;
        workTypeList.add(wt1);
        insert workTypeList;   
        
        WorkType wt2 = new WorkType();
        wt2.Name = 'Contractor DLP';        
        wt2.EstimatedDuration = 1;
        insert wt2;
        
        WorkOrder woObj = new WorkOrder();
        woObj.CaseId = caseObj.Id;
        woObj.AccountId = acc.Id;
        woObj.WorkTypeId =  wt1.Id;
        woObj.Status = 'New';
        insert woObj;
        FSL__Scheduling_Policy__c scpolicy = New FSL__Scheduling_Policy__c();
        scpolicy.Name = 'Aldar Scheduling Policy';
        insert scpolicy;   
        
        WorkOrderLineItem woliDlp = new WorkOrderLineItem();
        woliDlp.WorkOrderId = woObj.id;
        woliDlp.WorkTypeId = wt1.id;
        woliDlp.Status = 'New';
        insert woliDlp;
        
        Id assessmentRecordTypeId = Schema.SObjectType.ServiceAppointment.getRecordTypeInfosByName().get('Assessment').getRecordTypeId();
        ServiceAppointment testSA = new ServiceAppointment();
        testSA.Case__c = caseObj.Id;
        testSA.ParentRecordId = woliDlp.Id;
        testSA.RecordTypeId = assessmentRecordTypeId ; 
        testSA.EarliestStartTime = system.today(); 
        Insert testSA;
        
        testSA.SchedStartTime = system.today();        
        testSA.Status = 'Assigned';
        testSA.AccountEmailID__c = 'test@test.com'; 
        testSA.SchedEndTime = system.today()+1; 
        testSA.OwnerId  = UserInfo.getUserId();
        testSA.Supervisor__c = UserInfo.getUserId();
        testSA.Status = 'En Route';  
        testSA.Status = 'Work In Progress'; 
        testSA.Quick_Fix__c=false;  
        testSA.Status = 'Closed';
        testSA.OwnerId = Userinfo.getUserId();
        testSA.Closed_Reason__c='Completed Succeessfully';
        Update  testSA  ; 
        newFeedbackCase3.Status='Closed';
        ContentVersion testContentVersion = new ContentVersion(
            Title = 'Test Document',
            VersionData = Blob.valueOf('Test Content'),
            PathOnClient = 'test.txt'
        );
        insert testContentVersion; 
        ContentDocumentLink existingContentLink = new ContentDocumentLink(
            ContentDocumentId = [SELECT Id FROM ContentDocument WHERE Title = 'Test Document' LIMIT 1].Id,
            LinkedEntityId = testSA.Id,
            ShareType = 'I'
        );
        insert existingContentLink;
        Set<id> caseIds =  new set<id>();
        caseIds.add(caseObj.id);
        CaseTriggerHandler.sendServiceReport(caseIds);            
    }
    
    
    
    
    @isTest
    public static void createUpdateCase4 (){
        FSL.GlobalAPIS.addStatusTransition('New', 'Closed');
        
        
        Map<String,Id> recordTypeSR = new Map<String,Id>();
        for(Recordtype rtype : [SELECT Id,DeveloperName FROM Recordtype WHERE SObjectType = 'HexaBPM__Service_Request__c' AND DeveloperName = 'PaymentExtension']){
            recordTypeSR.put(rtype.DeveloperName,rtype.Id);
        }
        
        Account acc = TestObjectsFactory.getPersonAccountRecord();
        acc.PassportNumber__pc = 'N6385378';
        acc.ResidentStatus__pc = 'Resident';
        acc.MaritalStatus__pc = 'Married';
        acc.EmploymentStatus__pc = 'Self Employed';
        acc.PersonEmail = 'test@aldar.com.invalid';
        acc.MobileCountryCode__pc = '971';
        acc.MobilePhone__pc = '9876543115';
        acc.Company__pc = 'XXXXX';
        acc.Position__pc = 'XXX';
        acc.CompanyAddress__pc = 'NA';
        acc.NoofYearswithCompany__pc = 10;
        acc.Industry = 'Agriculture';
        acc.NationalIdNumber__pc = '784123456789012';
        acc.AnnualIncome__pc = 1234567;
        acc.SourceofFunds__pc = 'Profits/Salary';
        acc.OwnerManagerEmail__c = 'test@gmail.com';
        acc.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert acc;
        
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(acc.Id);
        insert opp;
        
        List<Unit__c> unitList=new List<Unit__c>();
        Unit__c unit = TestObjectsFactory.unitDataSetup('25083');
        unit.Status__c = 'Sold';
        //insert unit;
        unitList.add(unit);
        
        ProjectBudget__c projectBudget = TestObjectsFactory.getProjectBudget();
        insert projectBudget;
        
        Project__c project = TestObjectsFactory.getProjectRecord('ABC');
        project.ProjectBudget__c = projectBudget.Id;
        project.CommunityName__c = 'Noya';
        insert project;
        
        User salesManager = TestObjectsFactory.getUserRecord('Sales Manager', 'ajaythakurSM1');
        salesManager.IsActive = TRUE;
        insert salesManager;
        
        Unit__c unit2 = TestObjectsFactory.unitDataSetup('25084');
        unit2.Project__c = project.id;
        unit2.Status__c = 'New';
        unit2.AssignedToUser__c = salesManager.Id;
        unit2.LatitudeLongitude__Latitude__s=32.987650;
        unit2.LatitudeLongitude__Longitude__s=72.345678;
        unitList.add(unit2);
        insert unitList;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, acc.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.NetAmount__c = 1000;
        salesOrder.SellingPrice__c = 1000;
        insert salesOrder;
        test.startTest();
        HexaBPM__SR_Template__c SR_Template = new HexaBPM__SR_Template__c();
        SR_Template.Name = 'Payment Extension';
        SR_Template.HexaBPM__SR_RecordType_API_Name__c='PaymentExtension';
        insert SR_Template;
        
        HexaBPM__Service_Request__c SR = new HexaBPM__Service_Request__c();
        SR.RecordTypeId = recordTypeSR.get('PaymentExtension');
        SR.HexaBPM__Customer__c = acc.Id;
        SR.HexaBPM__Contact__c = acc.PersonContactId;
        SR.OwnerId = UserInfo.getUserId();
        SR.HexaBPM__SR_Template__c = SR_Template.Id;
        SR.Unit__c = unit.Id;
        SR.SalesOrder__c = salesOrder.Id;
        insert SR;
        
        HexaBPM__Step_Template__c ST = new HexaBPM__Step_Template__c();
        ST.Name = 'Verify the Request';
        ST.HexaBPM__Code__c = 'Verify the Request';
        ST.HexaBPM__Step_RecordType_API_Name__c = 'General';
        insert ST;
        
        HexaBPM__SR_Steps__c SRStep = new HexaBPM__SR_Steps__c();
        SRStep.HexaBPM__SR_Template__c = SR_Template.id;
        SRStep.HexaBPM__Step_No__c = 1;
        SRStep.HexaBPM__Step_Template__c = ST.Id;
        SRStep.HexaBPM__Summary__c = 'Verify the Request';
        SRStep.HexaBPM__Step_RecordType_API_Name__c = 'General';
        insert SRStep;
        
        list<HexaBPM__Status__c> stepStatus = new list<HexaBPM__Status__c>{ new HexaBPM__Status__c(Name=Constants.STEP_STATUS_PENDING, HexaBPM__Code__c=Constants.STEP_STATUS_PENDING , HexaBPM__Type__c = 'Start'),
            new HexaBPM__Status__c(Name=Constants.STEP_STATUS_COMPLETED, HexaBPM__Code__c=Constants.STEP_STATUS_COMPLETED , HexaBPM__Type__c = 'End')};
                insert stepStatus;
        
        HexaBPM__Step__c step = new HexaBPM__Step__c();
        step.HexaBPM__Summary__c = 'Verify the Request';
        step.HexaBPM__SR__c = SR.Id;
        step.HexaBPM__SR_Step__c = SRStep.Id;
        step.HexaBPM__Start_Date__c = System.today();
        insert step; 
        
        // Id standardRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
        Id feedbackRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
        Case newFeedbackCase = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase.OwnerId = Userinfo.getUserId();
        newFeedbackCase.RecordId__c = SR.Id;
        insert newFeedbackCase;
        Test.stopTest();
        
    }
    
    
    @isTest
    public static void createUpdateCase5 (){
        FSL.GlobalAPIS.addStatusTransition('New', 'Closed');
        Test.startTest();
        Account acc = TestObjectsFactory.getPersonAccountRecord();
        acc.PassportNumber__pc = 'N6385378';
        acc.ResidentStatus__pc = 'Resident';
        acc.MaritalStatus__pc = 'Married';
        acc.EmploymentStatus__pc = 'Self Employed';
        acc.PersonEmail = 'test@aldar.com.invalid';
        acc.MobileCountryCode__pc = '971';
        acc.MobilePhone__pc = '9876543115';
        acc.Company__pc = 'XXXXX';
        acc.Position__pc = 'XXX';
        acc.CompanyAddress__pc = 'NA';
        acc.NoofYearswithCompany__pc = 10;
        acc.Industry = 'Agriculture';
        acc.NationalIdNumber__pc = '784123456789012';
        acc.AnnualIncome__pc = 1234567;
        acc.SourceofFunds__pc = 'Profits/Salary';
        acc.OwnerManagerEmail__c = 'test@gmail.com';
        acc.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert acc;
        
        Opportunity opp = TestObjectsFactory.getOpportunityRecord(acc.Id);
        insert opp;
        
        List<Unit__c> unitList=new List<Unit__c>();
        Unit__c unit = TestObjectsFactory.unitDataSetup('25083');
        unit.Status__c = 'Sold';
        unitList.add(unit);
        insert unitList;
        
        SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, acc.Id);
        salesOrder.Unit__c = unit.Id;
        salesOrder.NetAmount__c = 1000;
        salesOrder.SellingPrice__c = 1000;
        insert salesOrder;
        
        Id feedbackRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
        Case newFeedbackCase = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase.OwnerId = Userinfo.getUserId();
        
        Case newFeedbackCase2 = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase2.SubVertical__c = Constants.DLP_SUB_VERTICAL;
        newFeedbackCase2.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase2.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase2.OwnerId = Userinfo.getUserId();
        newFeedbackCase2.RecordId__c = opp.Id;
        
        Case newFeedbackCase3 = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase3.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase3.CaseCategory__c = Constants.QUALTRICS_SURVEY_CATEGORY;
        newFeedbackCase3.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase3.OwnerId = Userinfo.getUserId();
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase3.RecordId__c = salesOrder.Id;
        newFeedbackCase3.AccountId=acc.id;
        newFeedbackCase3.Subject='Noya-Civil';
        
        Id recordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('DLP').getRecordTypeId();
        
        Case newFeedbackCase4 = TestObjectsFactory.getCaseRecord(feedbackRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
        newFeedbackCase4.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        newFeedbackCase4.CaseCategory__c = Constants.CONTACT_DETAILS_UPDATE_CATEGORY;
        newFeedbackCase4.Origin = Constants.SURVEY_CASE_ORIGIN;
        newFeedbackCase4.OwnerId = Userinfo.getUserId();
        newFeedbackCase.CustomerType__c = 'Owner';
        newFeedbackCase4.RecordId__c = salesOrder.Id;
        newFeedbackCase4.AccountId=acc.id;
        newFeedbackCase4.Subject='Noya-Civil';
        
        Case caseObj = new Case();
        caseObj.AccountId = acc.id;
        caseObj.RecordtypeId = recordTypeId;
        caseObj.Unit__c=unit.id;
        caseObj.Status = 'New';
        caseObj.Subject = 'Test Case';
        caseObj.Single_DLP_slot__c = true;
        caseObj.Skills_Required__c = 'Electrician';
        
        List<case> caselist=new List<case>();
        caselist.add(newFeedbackCase);
        caselist.add(newFeedbackCase3);
        insert caselist;
        
        Test.stopTest();
        
        List<WorkType> workTypeList=new  List<WorkType>();
        WorkType wt = new WorkType();
        wt.Name = 'Electrician';        
        wt.EstimatedDuration = 1;
        workTypeList.add(wt);
        WorkType wt1 = new WorkType();
        wt1.Name = 'DLP Executive';        
        wt1.EstimatedDuration = 1;
        workTypeList.add(wt1);
        insert workTypeList;
        update caselist;        
        
        WorkType wt2 = new WorkType();
        wt2.Name = 'Contractor DLP';        
        wt2.EstimatedDuration = 1;
        insert wt2;
        
        WorkOrder woObj = new WorkOrder();
        woObj.CaseId = caseObj.Id;
        woObj.AccountId = acc.Id;
        woObj.WorkTypeId =  wt1.Id;
        woObj.Status = 'New';
        insert woObj;
        
        
        FSL__Scheduling_Policy__c scpolicy = New FSL__Scheduling_Policy__c();
        scpolicy.Name = 'Aldar Scheduling Policy';
        insert scpolicy;
        
        WorkOrderLineItem woliDlp = new WorkOrderLineItem();
        woliDlp.WorkOrderId = woObj.id;
        woliDlp.WorkTypeId = wt1.id;
        woliDlp.Status = 'New';
        insert woliDlp;
        
        Id assessmentRecordTypeId = Schema.SObjectType.ServiceAppointment.getRecordTypeInfosByName().get('Assessment').getRecordTypeId();
        ServiceAppointment testSA = new ServiceAppointment();
        testSA.Case__c = caseObj.Id;
        testSA.ParentRecordId =  woliDlp.Id;
        testSA.RecordTypeId = assessmentRecordTypeId ; 
        
        testSA.EarliestStartTime = system.today(); 
        Insert testSA;
        
        testSA.SchedStartTime = system.today();        
        testSA.Status = 'Assigned';
        testSA.AccountEmailID__c = 'test@test.com'; 
        testSA.SchedEndTime = system.today()+1; 
        testSA.OwnerId  = UserInfo.getUserId();
        testSA.Supervisor__c = UserInfo.getUserId();
        
        
        testSA.Status = 'En Route';  
        
        testSA.Status = 'Work In Progress'; 
        testSA.Quick_Fix__c=false;  
        
        
        testSA.Status = 'Closed';
        
        testSA.OwnerId = Userinfo.getUserId();
        
        testSA.Closed_Reason__c='Completed Succeessfully';
        Update  testSA  ; 
        
        
        newFeedbackCase3.Status='Closed';
        // update newFeedbackCase3;
        
        ContentVersion testContentVersion = new ContentVersion(
            Title = 'Test Document',
            VersionData = Blob.valueOf('Test Content'),
            PathOnClient = 'test.txt'
        );
        insert testContentVersion; 
        ContentDocumentLink existingContentLink = new ContentDocumentLink(
            ContentDocumentId = [SELECT Id FROM ContentDocument WHERE Title = 'Test Document' LIMIT 1].Id,
            LinkedEntityId = testSA.Id,
            ShareType = 'I'
        );
        insert existingContentLink;
        Set<id> caseIds =  new set<id>();
        caseIds.add(caseObj.id);
        CaseTriggerHandler.sendServiceReport(caseIds);        
        
    }
    
    
    @isTest
    public static void createUpdateDLPcase (){
        FSL.GlobalAPIS.addStatusTransition('New', 'Closed');
        
        Account acc = TestObjectsFactory.getPersonAccountRecord();
        acc.PassportNumber__pc = 'N6385378';
        acc.ResidentStatus__pc = 'Resident';
        acc.MaritalStatus__pc = 'Married';
        acc.EmploymentStatus__pc = 'Self Employed';
        acc.PersonEmail = 'test@aldar.com.invalid';
        acc.MobileCountryCode__pc = '971';
        acc.MobilePhone__pc = '9876543115';
        acc.Company__pc = 'XXXXX';
        acc.Position__pc = 'XXX';
        acc.CompanyAddress__pc = 'NA';
        acc.NoofYearswithCompany__pc = 10;
        acc.Industry = 'Agriculture';
        acc.NationalIdNumber__pc = '784123456789012';
        acc.AnnualIncome__pc = 1234567;
        acc.SourceofFunds__pc = 'Profits/Salary';
        acc.OwnerManagerEmail__c = 'test@gmail.com';
        acc.OwnerManagerEmail__pc = 'test1@gmail.com';
        insert acc;                            
        
        
        Test.startTest();
        Map<Id, Case> closedCasesMap = new Map<Id, Case>();
        Task t = new Task();
        
        Id recordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('DLP').getRecordTypeId();
        
        User salesManager = TestObjectsFactory.getUserRecord('Sales Manager', 'ajaythakurSM1');
        salesManager.IsActive = TRUE;
        insert salesManager;
        
        ProjectBudget__c projectBudget = TestObjectsFactory.getProjectBudget();
        insert projectBudget;
        
        Project__c project = TestObjectsFactory.getProjectRecord('ABC');
        project.ProjectBudget__c = projectBudget.Id;
        project.CommunityName__c = 'Noya';
        insert project;
        
        Unit__c unit2 = TestObjectsFactory.unitDataSetup('25084');
        unit2.Project__c = project.id;
        unit2.Status__c = 'New';
        unit2.AssignedToUser__c = salesManager.Id;
        unit2.LatitudeLongitude__Latitude__s=32.987650;
        unit2.LatitudeLongitude__Longitude__s=72.345678;
        insert unit2;
        
        WorkType wt = new WorkType();
        wt.Name = 'Electrician';        
        wt.EstimatedDuration = 1;
        insert wt;
        
        WorkType wt1 = new WorkType();
        wt1.Name = 'DLP Executive';        
        wt1.EstimatedDuration = 1;
        insert wt1;
        
        OperatingHours oh = new OperatingHours();
        oh.Name = 'TestOH';
        insert oh;
        
        ServiceTerritory srvt = New ServiceTerritory();
        srvt.Name = 'Noya';
        srvt.OperatingHoursId = oh.Id;
        insert srvt;
        system.debug('srvt insert::'+srvt.Id);
        
        Case caseObj2 = new Case();
        caseObj2.AccountId = acc.id;
        //caseObj.ContactId=con.id;
        caseObj2.RecordtypeId = recordTypeId;
        caseObj2.Unit__c=unit2.id;
        caseObj2.Status = 'New';
        caseObj2.Subject = 'Test Case';
        caseObj2.Single_DLP_slot__c = false;
        caseObj2.Skills_Required__c = 'Electrician';
        caseObj2.Origin = 'Phone';        
        insert caseObj2;
        
        Case caseObj = new Case();
        caseObj.AccountId = acc.id;
        //caseObj.ContactId=con.id;
        caseObj.RecordtypeId = recordTypeId;
        caseObj.Unit__c=unit2.id;
        caseObj.Status = 'New';
        caseObj.Subject = 'Test Case';
        caseObj.Single_DLP_slot__c = true;
        caseObj.Skills_Required__c = 'Electrician';
        caseObj.Origin = 'Phone';
        insert caseObj;
        system.debug('DLPcase insert::'+caseObj.Id);
        
        caseObj2.CaseComments__c = 'Update DLP Case';
        caseObj2.Single_DLP_slot__c = true;
        try{
            update caseObj2;  
        }Catch(Exception e){}
        Test.stopTest();                 
        
    }
    
    @isTest
    public static void Onboardingtest (){
        
        Profile profile = [SELECT Id FROM Profile WHERE Name = 'System Administrator']; // Adjust profile name as needed
        User testUser = new User(
            ProfileId = profile.Id,
            LastName = 'Test',
            FirstName = 'User',
            Email = 'vireddy@aldar.com',
            Username = 'testuser@example.com' + System.currentTimeMillis(),
            Alias = 'tuser',
            EmailEncodingKey = 'UTF-8',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            TimeZoneSidKey = 'America/Los_Angeles',
            IsActive = true
        );
        insert testUser;
        
        PermissionSet psOnBoardCase = [SELECT Id,Name FROM PermissionSet Where Name = 'OnBoardingCase_Creation_Permission' Limit 1];
        
        PermissionSetAssignment psaOnBoardCase = new PermissionSetAssignment(
            AssigneeId = testUser.Id,
            PermissionSetId = psOnBoardCase.Id);
        insert psaOnBoardCase;
        
        system.runas(testuser)
        {		
            test.startTest();
            
            Project__c project = TestObjectsFactory.getProjectRecord('Test');
            project.AsiteProjectName__c = 'Test Project Name';
            insert project;
            
            BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
            insert buildingSection;
            
            Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
            unit.Status__c = 'Sold';
            insert unit;
            
            Account newAccount = TestObjectsFactory.getPersonAccountRecord();
            newAccount.PassportNumber__pc = 'N6385378';
            newAccount.ResidentStatus__pc = 'Resident';
            newAccount.MaritalStatus__pc = 'Married';
            newAccount.EmploymentStatus__pc = 'Self Employed';
            newAccount.PersonEmail = 'test@aldar.com.invalid';
            newAccount.MobileCountryCode__pc = '971';
            newAccount.MobilePhone__pc = '9876543115';
            newAccount.Company__pc = 'XXXXX';
            newAccount.Position__pc = 'XXX';
            newAccount.CompanyAddress__pc = 'NA';
            newAccount.NoofYearswithCompany__pc = 10;
            newAccount.Industry = 'Agriculture';
            newAccount.AnnualIncome__pc = 1234567;
            newAccount.NationalIdNumber__pc = '784123456789012';
            newAccount.SourceofFunds__pc = 'Profits/Salary';
            newAccount.OwnerManagerEmail__c = 'test@gmail.com';
            newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';
            insert newAccount;
            
            Opportunity opp = TestObjectsFactory.getOpportunityRecord(newAccount.Id);
            opp.OwnerManger__c = UserInfo.getUserId();
            insert opp;
            
            SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, newAccount.Id);
            salesOrder.Unit__c = unit.Id;
            salesOrder.IsBookingCompleted__c = true;
            salesOrder.NetAmount__c = 100000;
            salesOrder.Account__c = newAccount.Id;
            insert salesOrder;
            
            Id standardRecordTypeId = Utilities.getRecordTypeId('Case', 'Standard Case');
            TriggerHandler.processedIds = new Set<Id>();
            Case updatecase = TestObjectsFactory.getCaseRecord(standardRecordTypeId, Constants.PAYMENT_EXTENSION_TYPE, unit.Id, 'Phone');
            updatecase.SubVertical__c = system.label.Case_Subvertical_Onboarding;
            updatecase.CaseCategory__c = system.label.Case_Subvertical_Onboarding;
            updatecase.Unit__c = unit.Id;
            updatecase.subject='Test';
            updatecase.CustomerType__c = 'Owner';
            
            insert updatecase;
            updatecase.OwnerId = testuser.Id;
            UPDATE updatecase;
            test.stopTest();
        }       
        
    }
    
    @isTest
    public static void newcaseRevampTest_1(){
        Test.startTest();
        Id requestrecTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('Requests').getRecordTypeId();
        Id comprecTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('Complaints').getRecordTypeId();
        
        Case cs = [Select Id,SubVertical__c,CaseCategory__c From Case Where CaseCategory__c = 'Home Finance' Limit 1];
        
        cs.RecordTypeId = requestrecTypeId;
        cs.Origin = 'Phone';
        cs.CustomerType__c = 'Owner';
        cs.CaseCategory__c = 'Contact Center';
        cs.SubCategory__c = 'Customer Feedback';
        cs.Priority='P2';
        cs.IsScreenCase__c = true;
        update cs;
        
        cs.Priority='P3';
        cs.status='Resolved';
        // cs.RecordTypeId = comprecTypeId;
        update cs;
    }
    
    
    @isTest
    public static void newcaseRevampTest_2(){
        Id requestsRecordTypeId =  Utilities.getRecordTypeId('Case', 'Requests');
        Case newRequestCase = new Case();
        newRequestCase.RecordTypeId = requestsRecordTypeId;
        newRequestCase.Origin = 'Phone';
        newRequestCase.CustomerType__c = 'Owner';
        newRequestCase.CaseCategory__c = 'Contact Center';
        newRequestCase.SubCategory__c = 'Dropped calls';
        newRequestCase.Priority='P1';
        // newRequestCase.status='New';
        newRequestCase.IsScreenCase__c = true;
        insert newRequestCase; 
        Test.startTest();
        try{
            TriggerHandler.processedIds = new Set<Id>();
            newRequestCase.status='Resolved';
            update newRequestCase;
            
            TriggerHandler.processedIds = new Set<Id>();
            newRequestCase.Assigned_To__c=UserInfo.getUserId();
            update newRequestCase;
        }Catch(Exception e){}
        Test.stopTest();  
    }  
    
    @isTest
    public static void createAsset(){
        Test.StartTest();
        Id recordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('StandardCase').getRecordTypeId();
        
        Case cs = [Select Id,SubVertical__c,CaseCategory__c,ECSS_Object_Category__c From Case Where CaseCategory__c = 'Home Finance' Limit 1];
        
        Asset asset = new asset(Name = 'Test Asset');
        insert asset;
        
        cs.RecordTypeId = recordTypeId; 
        cs.ECSS_CompanyOptions__c = 'AlDar Properties';
        cs.SubVertical__c = Constants.CONTACT_CENTRE_SUB_VERTICAL;
        cs.CaseCategory__c = Constants.CONTACT_DETAILS_UPDATE_CATEGORY;
        
        cs.AssetId = asset.Id;
        update cs;
        List<Case> caseList = new List<Case>{cs};
            CaseTriggerHandler.populateOwnerIdfromProjectMetadata(new Set<Id>{asset.Id}, caseList);
        Test.StopTest();
        
    }
    @isTest
    public static void testCheckUserQueue() {
        
        Group testGroup = new Group(
            Name = 'Test Public Group',
            Type = 'Regular' 
        );
        insert testGroup;
        
        Profile p = [SELECT Id FROM Profile WHERE Name = 'Standard User' LIMIT 1];
        User testUser = new User(
            Alias = 'tusr',
            Email = 'testuser@example.com',
            EmailEncodingKey = 'UTF-8',
            LastName = 'Test',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            ProfileId = p.Id,
            TimeZoneSidKey = 'America/Los_Angeles',
            Username = 'testuser' + DateTime.now().getTime() + '@example.com',
            IsActive = true
        );
        insert testUser;
        
        GroupMember gm = new GroupMember(
            GroupId = testGroup.Id,
            UserOrGroupId = testUser.Id
        );
        insert gm;
        
        Test.startTest();
        Map<Id,String> result = CaseTriggerHandler.checkUserQueue('Test Public Group');
        Test.stopTest();
    }
    
    @isTest
    public static void testAutoAssignmentBulk() {
        
        Id recordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('Resale').getRecordTypeId();
        Profile p = [SELECT Id FROM Profile WHERE Name = 'System Administrator' LIMIT 1];
        User salesUser = new User(
            FirstName = 'Sales', LastName = 'User', Email = 'sales@test.com',
            Username = 'salesuser' + System.currentTimeMillis() + '@test.com', Alias = 'suser',
            EmailEncodingKey = 'UTF-8', LanguageLocaleKey = 'en_US', LocaleSidKey = 'en_US',
            TimeZoneSidKey = 'Asia/Dubai', ProfileId = p.Id
        );
        insert salesUser;
        
        System.runAs(salesUser){
            Test.startTest();
            Account acc = new Account(
                FirstName = 'Test', LastName = 'Account', PersonEmail = 'acc@test.com',
                OwnerManagerEmail__c = 'test@gmail.com',
                OwnerManagerEmail__pc = 'test1@gmail.com',
                OwnerId = salesUser.Id
            );
            insert acc;
            
            Opportunity opp = new Opportunity(
                Name = 'Test Opp', StageName = 'Prospecting', CloseDate = Date.today().addDays(30),
                AccountId = acc.Id, SalesManager__c = salesUser.Id
            );
            insert opp;
            
            Project__c project = TestObjectsFactory.getProjectRecord('Noya');
            project.AsiteProjectName__c = 'Test Project Name';
            project.Name = 'Noya';
            project.EligibleforResale__c = true;
            insert project;
            
            BuildingSection__c buildingSection = TestObjectsFactory.getBuildingDetailRecord(project.Id);
            insert buildingSection;
            
            Unit__c unit = TestObjectsFactory.getUnitDetail(project.Id, buildingSection.Id);
            unit.Status__c = 'Sold';
            
            insert unit;
            
            SalesOrder__c salesOrder = TestObjectsFactory.getSalesOrderRecord(opp.Id, acc.Id);
            salesOrder.Unit__c = unit.Id;
            salesOrder.IsBookingCompleted__c = true;
            salesOrder.NetAmount__c = 100000;
            salesOrder.Account__c = acc.Id;
            salesOrder.Status__c = 'Sold'; 
            insert salesOrder;
            
            Case resaleCase = new Case( 
                Subject = 'Resale Case', AccountId = acc.Id, Unit__c = unit.Id,
                RecordtypeId = recordTypeId, Status = 'New',SalesOrder__c = salesOrder.Id
            );
            insert resaleCase;
            
            Case salesCase = new Case(AccountId = acc.Id, Subject = 'Sales Case');
            Case brokerCase = new Case(AccountId = acc.Id, Subject = 'Broker Case');
            Case resaleQueueCase = new Case(AccountId = acc.Id, Unit__c = unit.Id, Subject = 'Resale Queue Case');
            
            insert new List<Case>{salesCase, brokerCase,resaleQueueCase};
                
                Map<Id, Case_Field_Dependency_Revised__mdt> metadataMap = new Map<Id, Case_Field_Dependency_Revised__mdt>();
            metadataMap.put(salesCase.Id, new Case_Field_Dependency_Revised__mdt(Auto_Assingment__c = 'Sales queue'));
            metadataMap.put(brokerCase.Id, new Case_Field_Dependency_Revised__mdt(Auto_Assingment__c = 'Broker queue'));
            metadataMap.put(resaleQueueCase.Id, new Case_Field_Dependency_Revised__mdt(Auto_Assingment__c = 'ReSale queue'));
            
            Map<Id, Case> caseMap = new Map<Id, Case>{
                salesCase.Id => salesCase,
                    brokerCase.Id => brokerCase,
                    resaleQueueCase.Id => resaleQueueCase
                    };
                        CaseTriggerHandler.autoassigmentBulk(caseMap, metadataMap);
            Test.stopTest();
        }  
    }
     @isTest

public static void testPopulateECSSData() {

           Account newAccount = TestObjectsFactory.getPersonAccountRecord();

            newAccount.PassportNumber__pc = 'N6385378';

            newAccount.ResidentStatus__pc = 'Resident';

            newAccount.MaritalStatus__pc = 'Married';

            newAccount.EmploymentStatus__pc = 'Self Employed';

            newAccount.PersonEmail = 'test@aldar.com.invalid';

            newAccount.MobileCountryCode__pc = '971';

            newAccount.MobilePhone__pc = '9876543115';

            newAccount.Company__pc = 'XXXXX';

            newAccount.Position__pc = 'XXX';

            newAccount.CompanyAddress__pc = 'NA';

            newAccount.NoofYearswithCompany__pc = 10;

            newAccount.Industry = 'Agriculture';

            newAccount.AnnualIncome__pc = 1234567;

            newAccount.NationalIdNumber__pc = '784123456789012';

            newAccount.SourceofFunds__pc = 'Profits/Salary';

            newAccount.OwnerManagerEmail__c = 'test@gmail.com';

            newAccount.OwnerManagerEmail__pc = 'test1@gmail.com';

            insert newAccount;



    RecordType rt = [SELECT Id FROM RecordType WHERE SObjectType='Case' LIMIT 1];

    

    // Assume Unit__c is a lookup object; create test unit

    

            Project__c project = new Project__c(Name = 'Project Test', ProjectCode__c = 'PTCode',BusinessUnitId__c ='1234');

            Insert project;

            

            RecordType buildingRecordType = [Select Id from RecordType where Name = 'Building' limit 1];

            BuildingSection__c bs = new BuildingSection__c(RecordTypeId = buildingRecordType.Id, Name = 'BuildingSection Test',BuildingSectionCode__c = 'BuildingSection TestCode',Project__c = project.Id);

            Insert bs;

            

            RecordType unitRecordType = [Select Id from RecordType where Name = 'Unit' limit 1];

            Unit__c unit = new Unit__c(RecordTypeId = unitRecordType.Id,

                                      Name='Test Unit',

                                      StartDate__c = System.today(),

                                      EndDate__c = System.today().addMonths(6),

                                      BuildingSectionName__c = bs.Id,

                                      Project__c = project.Id,

                                      SellingPrice__c = 12345,

                                      UnitType__c = 'Terraced Apartment',

                                      DarcomUnitFolder__c = 'http://test/testsales/testresidential/TestUnit');

            insert unit;

    // 2. Create Cases

    Case caseObj1 = new Case(

        AccountId = newAccount.Id,

        RecordTypeId = rt.Id,

        Unit__c = unit.Id,

        Status = 'New',

        Subject = 'Test Case 1',

        Single_DLP_slot__c = false,

        Skills_Required__c = 'Electrician',

        Origin = 'Phone'

    );



    Case caseObj2 = new Case(

        AccountId = newAccount.Id,

        RecordTypeId = rt.Id,

        Unit__c = unit.Id,

        Status = 'New',

        Subject = 'Test Case 2',

        Single_DLP_slot__c = true,

        Skills_Required__c = 'Electrician',

        Origin = 'Phone'

    );



    insert new List<Case>{caseObj1, caseObj2};



    // 3. Prepare caseCatSubCatMap

    Map<Id, String> caseCatSubCatMap = new Map<Id, String>();

    caseCatSubCatMap.put(caseObj1.Id, 'SubVertical1|Category1|ObjectCat1|SubCat1'); // match MDT key

    caseCatSubCatMap.put(caseObj2.Id, 'NonExistingKey'); // this will test else branch



    // 4. Query cases for the method

    List<Case> caseList = [SELECT Id, ECSS_Account_Contract_Request__c, ECSS_isCaseApproved__c, 

                                   Organization__c, Department__c, Vertical__c, Priority, 

                                   ECSS_DamageCode__c, ECSS_CaseCategoryCode__c

                            FROM Case 

                            WHERE Id IN :caseCatSubCatMap.keySet()];



    // 5. Call method under test

    Test.startTest();

    CaseTriggerHandler.populateECSSData(caseCatSubCatMap, caseList);

    Test.stopTest();

}

@isTest static void testByPassCaseTriggerSetsFlag() {
        Account a = new Account(Name = 'Bypass Test Acc');
        insert a;
        
        try {
            CaseTriggerHandler.isByPassCaseTrigger = false;
        } catch (Exception e) {
        }
        
        Test.startTest();
        CaseTriggerHandler.byPassCaseTrigger(new List<Id>{ a.Id });
        Test.stopTest();
        
        try {
            System.assertEquals(true, CaseTriggerHandler.isByPassCaseTrigger,
                                'isByPassCaseTrigger should be true after invoking byPassCaseTrigger');
            CaseTriggerHandler.isByPassCaseTrigger = false;
        } catch (Exception ex) {
            
        }
    }
    
    
    
    
    @isTest
    static void test_validateQualtricsCaseEligibility_covers_if_branch() {
        Profile p = [SELECT Id FROM Profile WHERE Name = 'System Administrator' LIMIT 1];
        User u = new User(
            FirstName='T', LastName='User', Alias='tuser', Email='tuser'+DateTime.now().getTime()+'@test.com',
            Username='tuser'+DateTime.now().getTime()+'@test.com',
            TimeZoneSidKey='Asia/Kolkata', LocaleSidKey='en_US', EmailEncodingKey='UTF-8', LanguageLocaleKey='en_US',
            ProfileId = p.Id
        );
        insert u;
        System.runAs(u) {
            Account acc = new Account(Name = 'Qualtrics Test Account');
            insert acc;
            
            Id rtIdToUse;
            try {
                rtIdToUse = Schema.SObjectType.Case
                    .getRecordTypeInfosByName()
                    .get(Constants.FEEDBACK_CASE_RT)
                    .getRecordTypeId();
            } catch (Exception ex) {
                rtIdToUse = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().values().iterator().next().getRecordTypeId();
            }
            
            Case oldCase = new Case(
                AccountId = acc.Id,
                Subject = 'Qualtrics Eligibility Old',
                Status = 'New',                    
                RecordTypeId = rtIdToUse,
                Vertical__c = 'DLP',       
                Survey_Required__c = true,          
                Qualtrics_Survey_Required__c = false
            );
            insert oldCase;
            
            Case updatedCase = new Case(
                Id = oldCase.Id,
                Status = 'Closed',                           
                Survey_Required__c = false,                  
                Qualtrics_Survey_Required__c = true,         
                Origin = 'Phone',                             
                Vertical__c = 'DLP',                         
                RecordTypeId = rtIdToUse,
                DLP_Closure_Reason__c = 'SomeOtherReason',   
                AMC_Closure_Reason__c = 'SomeOtherReason',
                AccountId = acc.Id
            );
            
            
            List<SObject> newCaseList = new List<SObject>{ updatedCase };
                Map<Id, SObject> oldMap = new Map<Id, SObject>{ oldCase.Id => oldCase };
                    
                    Test.startTest();
            Set<Id> result = CaseTriggerHandler.validateQualtricsCaseEligibility(newCaseList, oldMap);
            Test.stopTest();
            
            System.assert(result.contains(oldCase.Id), 'Expected the closed case Id to be returned (branch should be covered).');
        }
    }
    
    
    
    //------------------------------------------------
    //
    //
    
    @isTest
    private static void test_tasksValidation() {
        
        // 1. Create Case
        Case c = new Case(
            RecordTypeId = Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get('Queries').getRecordTypeId(),
            Origin = 'Phone'
        );
        insert c;
        
        // 2. Create tasks for that Case
        List<Task> taskList = new List<Task>();
        
        taskList.add(new Task(
            WhatId = c.Id,
            TaskNumber__c = 1
            //   CustomerResponse__c = 'Not Reached'
        ));
        
        taskList.add(new Task(
            WhatId = c.Id,
            TaskNumber__c = 2
            // CustomerResponse__c = 'Not Reached'
        ));
        
        taskList.add(new Task(
            WhatId = c.Id,
            TaskNumber__c = 3
            //  CustomerResponse__c = 'Customer Reached'   // this adds +4 weight
        ));
        
        insert taskList;
        
        // 3. Query System Message metadata
        SystemMessages__mdt msg = [
            SELECT Message__c 
            FROM SystemMessages__mdt 
            WHERE DeveloperName = 'CASE_TASKS_VALIDATION'
            LIMIT 1
        ];
        
        // 4. Prepare Map<Id, Case> for method call
        Map<Id, Case> caseMap = new Map<Id, Case>([SELECT Id FROM Case WHERE Id = :c.Id]);
        
        Test.startTest();
        CaseTriggerHandler.tasksValidation(caseMap);
        Test.stopTest();
        
        // 5. Validate 
        System.assertEquals(
            true,
            caseMap.get(c.Id).getErrors().size() > 0,
            'Case should show validation error'
        );
    }
    
    
    @isTest
    private static void test_populateSubVerticalMetadataQueryOnly() {
        
        
        CaseFieldDependency__mdt dep = [
            SELECT SubVertical__c, CaseCategory__c, SubCategory__c,
            ProblemCode__c, IncidentDescription__c, ResolutionType__c,
            Priority__c, EscalationPriority__c,
            Survey_Required__c, Email_Not_Triggered__c
            FROM CaseFieldDependency__mdt
            WHERE SubVertical__c != null
            LIMIT 1
        ];
        
        
        
        Case_Code_Red_Allow_Users__mdt allowedUser = [
            SELECT User_Email__c
            FROM Case_Code_Red_Allow_Users__mdt
            LIMIT 1
        ];
        
        
        
        
        Constant__mdt admConst = [
            SELECT DeveloperName, ConstantValue__c
            FROM Constant__mdt
            LIMIT 1
        ];
        
        
        Case parentCase = new Case(
            RecordTypeId = '012J7000000GwBzIAK',
            SubVertical__c = dep.SubVertical__c,
            CaseCategory__c = dep.CaseCategory__c,
            SubCategory__c = dep.CaseCategory__c,
            ProblemCode__c = dep.ProblemCode__c,
            //IncidentDescription__c = dep.IncidentDescription__c,
            ResolutionType__c = dep.ResolutionType__c,
            Vertical__c = admConst.DeveloperName
        );
        insert parentCase;
        
        
        Case childCase = new Case(
            RecordTypeId = '012J7000000GwBzIAK',
            ParentId = parentCase.Id,
            SubVertical__c = dep.SubVertical__c,
            CaseCategory__c = dep.CaseCategory__c,
            SubCategory__c = dep.SubCategory__c,
            ProblemCode__c = dep.ProblemCode__c,
            //IncidentDescription__c = dep.IncidentDescription__c,
            ResolutionType__c = dep.ResolutionType__c,
            Vertical__c = admConst.DeveloperName
        );
        insert childCase;
        
        
        Map<Id, String> subVMap = new Map<Id, String>{
            parentCase.Id => dep.SubVertical__c,
                childCase.Id => dep.SubVertical__c
                };
                    List<SObject> newList = new List<SObject>{ parentCase, childCase };
                        Map<Id, SObject> oldMap = new Map<Id, SObject>{
                            parentCase.Id => null,
                                childCase.Id => null
                                };
                                    
                                    
                                    
                                    Test.startTest();
        CaseTriggerHandler.populateSubVerticalDependentInfo(subVMap	, newList, oldMap);
        Test.stopTest();
        
        
    }
    
    
    // Helper method to get RT Id by dev name
    private static Id getRT(String devName) {
        return Schema.SObjectType.Case.getRecordTypeInfosByDeveloperName().get(devName).getRecordTypeId();
    }
    
    @isTest
    static void testEmailToRequestConversion() {
        
        // Mock labels
        
        // Record type IDs
        Id standardRT = getRT('StandardCase');
        Id requestsRT = getRT('Requests');
        
        // Test Case
        Case c = new Case(
            RecordTypeId = '0128d000001RXUVAA4',
            Origin       = 'Email',
            Subject      = 'Email conversion',
            Description  = 'Test'
        );
        insert c;
        
        Case cInserted = [SELECT RecordTypeId FROM Case WHERE Id = :c.Id];
        
        System.assertEquals(
            requestsRT,
            cInserted.RecordTypeId,
            'Email  Requests conversion failed'
        );
    }
    
    @isTest
    static void testStandardCaseSubVerticalValidationCoverage() {
        
        
        
        Case c = new Case(
            RecordTypeId  = '0128d000001RXUVAA4',
            Origin        = 'Phone',
            SubVertical__c = '',
            Subject       = 'Subvertical test'
        );
        
        Test.startTest();
        insert c;   // IF block evaluated  Covered
        Test.stopTest();
    }
    
    @isTest
    static void testEntitlementAssignment_P1_P2_P3() {
        
        Id requestsRT = getRT('Requests');
        
        // ------- P1 -------
        Case c1 = new Case(
            RecordTypeId = '012J7000000GwBzIAK',
            Priority     = 'P1',
            Subject      = 'P1 entitlement'
        );
        insert c1;
        
        System.assertEquals(
            System.Label.Case_Normal_Entitlement_ID,
            [SELECT EntitlementId FROM Case WHERE Id = :c1.Id].EntitlementId,
            'P1 entitlement incorrect'
        );
    }

}